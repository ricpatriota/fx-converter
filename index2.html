<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quick FX — Conversor</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f9fc; --card:#fff; --accent:#70bcf2; --muted:#6b7280; --ok:#27ae60; --danger:#e74c3c;
  }
  body{font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#eef7ff 0%, #f6f9fc 100%);padding:18px;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;}
  .wrap{width:100%;max-width:760px;background:var(--card);border-radius:12px;box-shadow:0 8px 30px rgba(15,23,42,.07);padding:20px;}
  h1{margin:0 0 8px;font-size:20px;color:#123b5d}
  p.lead{margin:0 0 16px;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="number"], select{width:100%;padding:10px;border:1px solid #e6eef6;border-radius:8px;font-size:15px}
  .row{display:flex;gap:12px;align-items:center}
  .result-card{margin-top:14px;padding:14px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#fbfeff);border:1px solid #e6f4ff}
  .result-line{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
  .big{font-weight:600;font-size:1.15rem;color:#0b334e}
  .small{color:var(--muted);font-size:13px}
  .btns{display:flex;gap:10px;margin-top:14px}
  .btn{padding:10px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer}
  .btn-primary{background:var(--accent);color:#fff}
  .btn-ghost{background:transparent;border:1px solid #dbeefa;color:#0b334e}
  .note{font-size:12px;color:var(--muted);margin-top:10px}
  @media(max-width:640px){ .grid{grid-template-columns:1fr} .row{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
  <div class="wrap" role="main">
    <h1>Conversor rápido de moedas</h1>
    <p class="lead">Digite o valor e veja a conversão em tempo real. Ao confirmar, você será redirecionado para a operação custom no app Cyclos.</p>

    <div class="grid">
      <div>
        <label for="fromCurrency">Moeda origem</label>
        <select id="fromCurrency"></select>
      </div>
      <div>
        <label for="toCurrency">Moeda destino</label>
        <select id="toCurrency"></select>
      </div>
      <div>
        <label for="amount">Valor origem</label>
        <input id="amount" type="number" min="0" step="0.01" value="100" />
      </div>
      <div>
        <label for="feePercent">Taxa (%) — opcional</label>
        <input id="feePercent" type="number" min="0" step="0.01" value="0" />
      </div>
    </div>

    <div class="result-card" id="resultCard" aria-live="polite">
      <div class="result-line"><div class="small">Você envia</div><div class="big" id="sendExact">—</div></div>
      <div class="result-line"><div class="small">Taxas (incluídas)</div><div class="small" id="feesTotal">—</div></div>
      <div class="result-line"><div class="small">Taxa de câmbio</div><div class="small" id="rateInfo">—</div></div>
      <div style="height:6px"></div>
      <div class="result-line"><div class="small">Valor convertido</div><div class="big" id="converted">—</div></div>
    </div>

    <div class="btns">
      <button id="sendBtn" class="btn btn-primary">Send money (abrir Cyclos)</button>
      <button id="copyBtn" class="btn btn-ghost">Copiar link</button>
    </div>
    <div class="note">Obs: API grátis usada: <a href="https://exchangerate.host" target="_blank">exchangerate.host</a>. Se quiser trocar por outra, eu adapto.</div>
  </div>

<script>
(async function(){
  // configuração
  const API = 'https://api.exchangerate.host';
  const DEFAULT_FROM = 'USD';
  const DEFAULT_TO = 'CAD';
  const DEFAULT_OPERATION_ID = 'customOperationIdOrInternalName'; // <<< coloque sua operation id/internalName
  const SCOPE = 'INTERNAL';

  // lista mínima de moedas (pode estender). A API suporta todas.
  const currencies = ["USD","CAD","EUR","GBP","MXN","HNL","NIO","GTQ","XAF","JPY","AUD","BRL","CNY"];

  const el = (id)=>document.getElementById(id);
  const fromSel = el('fromCurrency'), toSel = el('toCurrency'), amountEl = el('amount'),
        feeEl = el('feePercent'), sendBtn = el('sendBtn'), copyBtn = el('copyBtn'),
        sendExact = el('sendExact'), feesTotal = el('feesTotal'), converted = el('converted'), rateInfo = el('rateInfo');

  // preenche selects
  function fillSelect(sel, defaultVal){
    currencies.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c; opt.text = c;
      sel.appendChild(opt);
    });
    sel.value = defaultVal;
  }
  fillSelect(fromSel, DEFAULT_FROM);
  fillSelect(toSel, DEFAULT_TO);

  // debounce util
  function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

  // state
  let lastRateObj = {rate: null, date: null};

// fetch convert helper - using exchangerate.host convert endpoint
async function fetchConvert(from, to, amount){
  try {
    const url = `${API}/convert?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&amount=${encodeURIComponent(amount)}&access_key=157c74cb183654ebe943e5899dbc8f8e`;
    const resp = await fetch(url, {cache: 'no-store'});
    if (!resp.ok) throw new Error('Erro API: ' + resp.status);
    const json = await resp.json();

    // structure update: new API format fix
    // Some responses no longer include "info.rate" directly.
    const rate = json.info?.rate || json.result / amount || json.rate || 0;
    const date = json.date || new Date().toISOString().split('T')[0];

    return { ...json, rate, date };
  } catch (err) {
    console.error(err);
    return null;
  }
}


  // update UI
  async function update(){
    const from = fromSel.value, to = toSel.value;
    const rawAmount = parseFloat(amountEl.value || 0);
    const feePercent = parseFloat(feeEl.value || 0);

    // show immediate
    sendExact.textContent = `${from} ${rawAmount.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;

    const api = await fetchConvert(from, to, rawAmount || 1); // fetch rate (amount used only to get result)
    if(!api){
      rateInfo.textContent = 'Erro API';
      converted.textContent = '-';
      feesTotal.textContent = '-';
      return;
    }

    // compute values
    const rate =  (api.result / (api.query?.amount || 1));




    const convertedValue = (rawAmount * rate);
    const feesValue = rawAmount * (feePercent/100);
    const amountAfterFees = rawAmount - feesValue;



    // recompute converted considering fees applied on origin (common)
    const convertedAfterFees = amountAfterFees * rate;

    // format
    const fmt = (n) => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

    feesTotal.textContent = `${from} ${fmt(feesValue)} (${feePercent.toFixed(2)}%)`;
    rateInfo.textContent = `1 ${from} = ${rate.toFixed(6)} ${to} (date ${api.date})`;
    converted.textContent = `${to} ${fmt(convertedAfterFees)}`;

    // store for button
    lastRateObj.from = from; lastRateObj.to = to;
    lastRateObj.rawAmount = rawAmount;
    lastRateObj.feePercent = feePercent;
    lastRateObj.feesValue = feesValue;
    lastRateObj.convertedAfterFees = convertedAfterFees;
    lastRateObj.rate = rate;
  }

  const debUpdate = debounce(update, 250);

  // attach events
  fromSel.addEventListener('change', debUpdate);
  toSel.addEventListener('change', debUpdate);
  amountEl.addEventListener('input', debUpdate);
  feeEl.addEventListener('input', debUpdate);

  // initial
  await update();

  // build cyclos link
  function buildCyclosLink() {
    // Customize param names as you need (param1, param2...) or use names the operation expects.
    const params = {
      senderName: encodeURIComponent('PLACEHOLDER_SENDER'), // substitua dinamicamente se quiser
      recipientName: encodeURIComponent('PLACEHOLDER_RECIPIENT'),
      fromCurrency: encodeURIComponent(lastRateObj.from),
      toCurrency: encodeURIComponent(lastRateObj.to),
      amount: encodeURIComponent(lastRateObj.rawAmount.toFixed(2)),
      converted: encodeURIComponent(lastRateObj.convertedAfterFees.toFixed(2)),
      rate: encodeURIComponent(lastRateObj.rate.toString()),
      fees: encodeURIComponent(lastRateObj.feesValue.toFixed(2))
    };

    // montar query string
    const q = Object.keys(params).map(k => `${k}=${params[k]}`).join('&');
    return `wereldhave://runOperation?id=${DEFAULT_OPERATION_ID}&scope=${SCOPE}&${q}`;
  }

  
  // === TESTE: abrir URL fixa ===
  sendBtn.addEventListener('click', ()=> {
    window.location.href = 'wereldhave://runOperation?id=cotest2&scope=USER';
  });

  copyBtn.addEventListener('click', ()=> {
    navigator.clipboard?.writeText('wereldhave://runOperation?id=cotest2&scope=USER').then(()=>alert('Link copiado'));
  });

})();
</script>
</body>
</html>
